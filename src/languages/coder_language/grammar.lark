// Coder Language Grammar for Lark
// Based on the manager language grammar but adapted for coder agents

// Comments
COMMENT: /\/\/.*/

// Directives
directive: read | run | change | replace | insert | scratch | spawn | wait | finish

// Read directive - read any file in the codebase
read: "READ" filename

// Run directive - run terminal commands
run: "RUN" command

// Change directive - replace entire file contents
change: "CHANGE" "CONTENT" "=" content_string

// Replace directive - replace strings in the file with other strings (multiple items supported)
replace: "REPLACE" replace_item ("," replace_item)*
replace_item: "FROM" "=" from_string "TO" "=" to_string

// Insert directive - insert a string at the end of another string in the file
insert: "INSERT" "FROM" "=" from_string "TO" "=" to_string

// Scratch directive - write to scratch pad file
scratch: "SCRATCH" "CONTENT" "=" content_string

// Spawn directive - spawn ephemeral agents
spawn: "SPAWN" spawn_item ("," spawn_item)*
spawn_item: ephemeral_type prompt_field

// Wait directive - wait for ephemeral agents to complete
wait: "WAIT"

// Finish directive - complete the task
finish: "FINISH" prompt_field

// Filename is a quoted string
filename: string

// Command is a quoted string
command: string

// Ephemeral types
ephemeral_type: TESTER

// Prompt field
prompt_field: "PROMPT" "=" string

// Content string - uses regular quoted strings
content_string: string

// From and to strings for replace directive
from_string: string
to_string: string

// Regular string literals (for filenames, commands, prompts, content)
// A string can be either a traditional escaped double-quoted literal or a raw triple-quoted literal that may span multiple lines.
string: TRIPLE_STRING | STRING

// Ignore whitespace and comments
%import common.WS
%ignore WS
%ignore COMMENT

// Terminal definitions - ORDER MATTERS! More specific patterns first
// Triple-quoted strings capture everything verbatim until the closing delimiter, including newlines and quotes - MUST come before STRING
TRIPLE_STRING.10: /""".*?"""/s

// Traditional escaped double-quoted strings (existing behaviour) - cannot be empty (must have at least one character or escape)
STRING: /"([^"\\]|\\.)+"|""/

// Ephemeral type tokens
TESTER: "tester" 